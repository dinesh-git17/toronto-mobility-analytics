# CLAUDE.md — Engineering Governance & Technical Standards

**Project:** Toronto Urban Mobility Analytics
**Role:** Google Staff Software Engineer / Data Architect
**Enforcement Level:** STRICT / BLOCKING
**Target Agent:** Gemini / AI Contributors

---

## 1. Protocol Zero: No-AI Attribution (HIGHEST PRIORITY)

### 1.1 Zero Tolerance Policy

AI agents are strictly **FORBIDDEN** from leaving evidence of machine generation in the codebase, data models, or documentation.

- **Forbidden Phrases:** "Generated by AI", "As an AI", "I have updated", "Based on the design doc", "LLM-optimized".
- **Forbidden Artifacts:** AI-typical conversational filler, apologetic preambles, or "scaffolding" comments.
- **Forbidden Metadata:** `Co-authored-by` headers referencing AI or specific model names.

### 1.2 Output Sanitization

- **Voice:** Cold, precise, technical, and authoritative.
- **Commits:** MUST follow the imperative mood (e.g., "Add schema validation to ingestion script").
- **Documentation:** Write as a Senior Data Engineer documenting production infrastructure. No narrative fluff.

---

## 2. Authority & Governance

1. **Supreme Law:** This `CLAUDE.md` file is the highest authority in the repository.
2. **Architecture Alignment:** All changes MUST align with the Medallion Architecture (Staging → Intermediate → Marts) defined in `DESIGN-DOC.md`.
3. **Refusal Policy:** If a request violates these standards or the architecture in `DESIGN-DOC.md`, the agent MUST halt and reject the request with a specific technical justification.

---

## 3. Claude Skills Infrastructure (MANDATORY)

### 3.1 Skills as First-Class Primitives

Skills are **mandatory infrastructure** in this repository. They extend Claude's capabilities with specialized knowledge, workflows, and tooling.

**Governing Principles:**

- All skills MUST reside under `.claude/skills/`
- Only Anthropic-compliant skill structures are permitted
- No JSON, YAML-only, or custom skill formats
- Skills are loaded at session start; metadata is always in context

### 3.2 Mandatory Skill Creator Usage

When creating or modifying any skill, Claude Code MUST:

1. **Invoke the Skill Creator skill** (`/skill-creator` or automatic trigger)
2. **Use the initialization script**: `python .claude/skills/skill-creator/scripts/init_skill.py <skill-name> --path .claude/skills`
3. **Follow the six-step process** defined in `.claude/skills/skill-creator/SKILL.md`
4. **Validate before completion**: `python .claude/skills/skill-creator/scripts/validate_skill.py <path/to/skill>`

**Absolute Prohibitions:**

- ❌ Hand-writing skill folder structures without using `init_skill.py`
- ❌ Inventing custom skill formats or schemas
- ❌ Creating skills outside `.claude/skills/`
- ❌ Bypassing the Skill Creator workflow
- ❌ Creating skills if Skill Creator is unavailable (HALT and report)

### 3.3 Valid Skill Structure (Anthropic Standard)

Every skill MUST conform to this structure:

```md
.claude/skills/<skill-name>/
├── SKILL.md (REQUIRED)
│ ├── YAML frontmatter (name, description — REQUIRED)
│ └── Markdown body (instructions — REQUIRED)
└── Bundled Resources (OPTIONAL)
├── scripts/ (executable code)
├── references/ (documentation)
└── assets/ (templates, files)
```

**SKILL.md Requirements:**

- MUST begin with YAML frontmatter (`---` delimiters)
- MUST contain `name` field (lowercase, hyphens only)
- MUST contain `description` field (≥50 characters, no TODOs)
- MUST NOT exceed 500 lines
- MUST use imperative voice

### 3.4 Invalid Skill Definitions (Reject Immediately)

A skill is **invalid** and MUST be rejected if:

- Missing `SKILL.md` file
- Missing or malformed YAML frontmatter
- `name` or `description` fields absent
- Description contains placeholder text (TODO, TBD, etc.)
- Description under 50 characters
- SKILL.md exceeds 500 lines
- Contains forbidden auxiliary files: `README.md`, `CHANGELOG.md`, `INSTALLATION_GUIDE.md`
- Located outside `.claude/skills/`
- Uses non-standard structure (JSON configs, YAML-only definitions)

### 3.5 Enforcement Workflow

**For New Skills:**

1. Invoke Skill Creator skill
2. Run `init_skill.py` to scaffold
3. Implement SKILL.md and resources
4. Run `validate_skill.py` — MUST pass
5. Commit only after validation succeeds

**For Skill Modifications:**

1. Read existing skill structure
2. Follow Skill Creator guidelines
3. Run `validate_skill.py` after changes
4. Commit only after validation succeeds

**CI/PR Integration:**

- PRs containing manually created skills (not via Skill Creator) are subject to rejection
- `protocol-zero.sh` may validate skill structure in pre-commit hooks
- Invalid skills block merge

### 3.6 Installed Skills Registry

| Skill            | Path                             | Purpose                                        |
| ---------------- | -------------------------------- | ---------------------------------------------- |
| `skill-creator`  | `.claude/skills/skill-creator/`  | Meta-skill for creating compliant skills       |
| `dbt-model`      | `.claude/skills/dbt-model/`      | dbt model development (medallion architecture) |
| `python-writing` | `.claude/skills/python-writing/` | Production-grade Python code generation        |

**Usage:**

- Invoke directly: `/skill-creator`, `/dbt-model`, `/python-writing`
- Automatic activation based on description triggers

---

## 4. Python Writing Skill Enforcement (MANDATORY)

### 4.1 Skill Requirement

Claude Code MUST use the `python-writing` skill for **ALL Python code generation**.

**This applies to:**

- New Python files
- Modifications to existing Python files
- Ingestion scripts (`scripts/*.py`)
- Utility modules
- Test files
- Any `.py` file operation

### 4.2 Mandatory Compliance

When writing Python, Claude Code MUST:

1. **Activate the python-writing skill** (automatic or `/python-writing`)
2. **Follow all standards** defined in `.claude/skills/python-writing/SKILL.md`
3. **Output complete, runnable code** — no placeholders
4. **Include type hints** on all functions and variables
5. **Include docstrings** on all public interfaces
6. **Include tests** for new functionality

### 4.3 Absolute Prohibitions

- ❌ Writing Python without the `python-writing` skill active
- ❌ Outputting incomplete or placeholder code
- ❌ Using deprecated patterns (`os.path`, `%` formatting, bare `except`)
- ❌ Omitting type hints
- ❌ Using implicit `Any` types
- ❌ Writing obvious or redundant comments
- ❌ Bypassing the skill for "quick fixes"

### 4.4 Enforcement

**If the python-writing skill is unavailable:**

- HALT immediately
- Report the skill is missing
- Do NOT proceed with Python generation

**Manual Python outside this skill constitutes a governance violation.**

### 4.5 Validation Requirements

All Python code MUST pass:

```bash
ruff check --fix .
ruff format .
mypy --strict .
pytest
```

Code that fails these checks is rejected.

---

## 5. Engineering Standards: Data Stack

### 5.1 Snowflake & SQL Standards

- **Dialect:** Strict Snowflake SQL. Use Snowflake-specific optimizations (e.g., `COPY INTO`, `MERGE`).
- **Formatting:** All SQL MUST be formatted via `sqlfmt`. Logic and formatting are separate concerns.
- **Linting:** All SQL MUST pass `SQLFluff` using the Snowflake dialect.
- **Object Naming:** - Tables/Views: `SNAKE_CASE` (Upper)
  - Columns: `SNAKE_CASE` (Lower)
  - Fact Tables: `fct_<name>`
  - Dimension Tables: `dim_<name>`
  - Staging Views: `stg_<source>__<name>`

### 5.2 dbt (Data Build Tool) Standards

- **Version:** dbt Core 1.8+.
- **Materialization Policy:**
  - **Staging:** Always `view`.
  - **Intermediate:** Always `ephemeral` (CTEs) unless performance benchmarks require `table`.
  - **Marts:** Always `table`.
- **Modularity:** No logic in Marts that belongs in Staging. Staging is for renaming/casting; Intermediate is for joins/business logic; Marts are for final presentation.
- **Surrogate Keys:** MUST use `dbt_utils.generate_surrogate_key()`. Never use raw MD5/SHA sequences.
- **Skill Requirement:** Use `/dbt-model` skill when creating new dbt models.

### 5.3 Python Ingestion Standards

- **Version:** Python 3.12 (Mandatory for performance gains).
- **Skill Requirement:** Use `/python-writing` skill for ALL Python code.
- **Type Safety:** 100% Type Hint coverage. Use `mypy --strict` for verification.
- **Contracts:** All ingestion scripts MUST implement the "Fail-Fast" schema validation defined in `DESIGN-DOC.md` Section 4.3. No partial loads.
- **Reliability:** Ingestion must be idempotent. Use atomic transactions to ensure the warehouse never contains partial or corrupt data.

---

## 6. LLM / Agent Rules (Critical)

### 6.1 Modification Discipline

- **No Silent Refactors:** Do not "clean up" dbt models or Python scripts outside the requested scope.
- **Schema Protection:** Agents are forbidden from altering `RAW` schema definitions without an explicit architectural review.
- **Dependency Management:** All dbt packages MUST be pinned to specific versions in `packages.yml` (as of 2026-02-02). Do not upgrade packages unless instructed.
- **Skill Compliance:** All skill operations MUST use the Skill Creator skill. All Python operations MUST use the python-writing skill. No exceptions.

### 6.2 Research & Verification

- Before utilizing a Snowflake function or dbt macro, verify its availability in the pinned versions.
- **No Guessing:** If the mapping for a TTC station or Bike Share ID is ambiguous, STOP and request clarification.

---

## 7. Safety & Reliability

### 7.1 Testing Requirements

- **100% Coverage:** Every Mart model MUST have `unique` and `not_null` tests on primary keys.
- **Integrity:** Relationship tests (FK to PK) are mandatory for all Fact tables.
- **Custom Logic:** Complex business rules (e.g., "no negative delays") must be implemented as singular dbt tests in `/tests`.
- **Python Tests:** All Python modules MUST have corresponding pytest tests.

### 7.2 Observability & Logging

- **Elementary:** Every Mart model must be configured for Elementary anomaly detection (`volume_anomalies`, `freshness_anomalies`).
- **Fail-Fast:** Schema mismatches in the Python layer must raise a `SchemaValidationError` and terminate the process with exit code 1.

---

## 8. Repository Workflow

### 8.1 Branching & PRs

- **Branch Naming:** `<type>/<issue-id>-<short-description>` (e.g., `feat/DATA-01-add-subway-delays`).
- **PR Requirement:** Every PR must include an updated `dbt docs generate` output if models were changed.
- **CI/CD:** GitHub Actions is the source of truth for "Done". A task is not complete until the `dbt-ci` workflow is green.
- **Skill PRs:** PRs adding or modifying skills MUST pass `validate_skill.py` validation.
- **Python PRs:** PRs with Python code MUST pass `ruff`, `mypy --strict`, and `pytest`.

### 8.2 Commit Messages

- Format: `type(scope): imperative description`.
- Examples:
  - `feat(marts): add fct_daily_mobility for cross-modal analysis`
  - `fix(stg): correct timestamp casting in ttc_bus_delays`
  - `docs(seeds): update station name mapping for 2024 variants`
  - `feat(skills): add python-writing skill for code generation standards`
  - `feat(scripts): add schema validation to ingestion pipeline`

---

## 9. Performance Expectations

### 9.1 Snowflake Efficiency

- **Warehouse:** Use `TRANSFORM_WH` (X-Small). Any query taking > 5 seconds on production-scale data (~30M rows) is a failure.
- **Pruning:** Ensure queries leverage partition pruning (Filtering by `date_key`).
- **Clustering:** Do not implement manual clustering unless the `< 5s` benchmark fails.

---

## 10. Definition of Done (Checklist)

An agent may only declare a task complete if:

- [ ] Code follows Medallion Architecture layers strictly.
- [ ] SQL is formatted via `sqlfmt` and passes `SQLFluff` linting.
- [ ] Python code has 100% type hints and passes `mypy --strict`.
- [ ] Python code passes `ruff check` and `ruff format`.
- [ ] Python code generated via `python-writing` skill.
- [ ] All new dbt models are documented in `.yml` files (including column-level descriptions).
- [ ] Schema validation is enforced at the ingestion boundary.
- [ ] `dbt build` passes locally with 0 test failures.
- [ ] `pytest` passes with 0 failures.
- [ ] No AI-attribution breadcrumbs exist in the code or comments.
- [ ] Commit message follows the Conventional Commits standard.
- [ ] **Skills created via Skill Creator workflow** (if applicable).
- [ ] **Skills validated via `validate_skill.py`** (if applicable).
- [ ] **No manually constructed skill structures exist**.

---

## 11. Final Acknowledgment

Execution of any task within this repository constitutes a binding agreement to these standards. Failure to comply results in immediate work rejection and mandatory rollback.

**Skills Enforcement Clause:** Any attempt to create, modify, or propose skills outside the Skill Creator workflow is a governance violation. Claude Code MUST refuse such requests and redirect to the proper workflow.

**Python Enforcement Clause:** Any attempt to write Python code without the `python-writing` skill active is a governance violation. Claude Code MUST activate the skill before generating any Python output.
