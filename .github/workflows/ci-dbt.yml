name: CI dbt

on:
  pull_request:
    branches: [main]
    paths:
      - "models/**"
      - "macros/**"
      - "seeds/**"
      - "analyses/**"
      - "tests/**"
      - "dbt_project.yml"
      - "packages.yml"
      - "profiles.yml.example"
      - ".github/workflows/ci-dbt.yml"
  push:
    branches: [main]
    paths:
      - "models/**"
      - "macros/**"
      - "seeds/**"
      - "analyses/**"
      - "tests/**"
      - "dbt_project.yml"
      - "packages.yml"
      - "profiles.yml.example"
      - ".github/workflows/ci-dbt.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  DBT_PROFILES_DIR: ${{ github.workspace }}

jobs:
  detect-dbt:
    runs-on: ubuntu-24.04
    outputs:
      has_dbt: ${{ steps.check.outputs.has_dbt }}
      has_models: ${{ steps.check.outputs.has_models }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for dbt project
        id: check
        run: |
          if [ -f "dbt_project.yml" ]; then
            echo "has_dbt=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_dbt=false" >> "$GITHUB_OUTPUT"
          fi
          if [ -d "models" ] && find models -name "*.sql" -type f | head -1 | grep -q .; then
            echo "has_models=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_models=false" >> "$GITHUB_OUTPUT"
          fi

  dbt-build:
    needs: detect-dbt
    if: needs.detect-dbt.outputs.has_dbt == 'true'
    runs-on: ubuntu-24.04
    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dbt
        run: |
          uv tool install "dbt-snowflake>=1.9.0"

      - name: Check Snowflake credentials
        id: creds
        run: |
          if [ -n "$SNOWFLAKE_ACCOUNT" ] && [ -n "$SNOWFLAKE_USER" ] && [ -n "$SNOWFLAKE_PASSWORD" ]; then
            echo "has_creds=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_creds=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Snowflake credentials not configured, skipping dbt build"
          fi

      - name: Create profiles.yml
        if: steps.creds.outputs.has_creds == 'true'
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          if [ -n "$PR_NUM" ]; then
            SCHEMA_SUFFIX="PR_${PR_NUM}_${SHORT_SHA}"
          else
            SCHEMA_SUFFIX="CI_${SHORT_SHA}"
          fi
          cat > profiles.yml << EOF
          toronto_mobility:
            target: ci
            outputs:
              ci:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: TRANSFORMER_ROLE
                database: TORONTO_MOBILITY
                warehouse: TRANSFORM_WH
                schema: CI_${SCHEMA_SUFFIX}
                threads: 4
          EOF

      - name: Cache dbt packages
        if: steps.creds.outputs.has_creds == 'true'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dbt_packages
          key: dbt-packages-${{ hashFiles('packages.yml') }}
          restore-keys: |
            dbt-packages-

      - name: Install dbt packages
        if: steps.creds.outputs.has_creds == 'true'
        run: |
          if [ -f "packages.yml" ]; then
            dbt deps
          fi

      - name: dbt debug
        if: steps.creds.outputs.has_creds == 'true'
        run: dbt debug

      - name: Download production manifest
        if: steps.creds.outputs.has_creds == 'true' && github.event_name == 'pull_request'
        continue-on-error: true
        id: manifest
        run: |
          mkdir -p prod_artifacts
          if gh run download --name dbt-artifacts --dir prod_artifacts 2>/dev/null; then
            echo "has_manifest=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_manifest=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No production manifest found, running full build"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: dbt build (Slim CI)
        if: steps.creds.outputs.has_creds == 'true' && github.event_name == 'pull_request' && steps.manifest.outputs.has_manifest == 'true'
        run: |
          dbt build --select state:modified+ --defer --state prod_artifacts --fail-fast

      - name: dbt build (Full)
        if: steps.creds.outputs.has_creds == 'true' && (github.event_name == 'push' || steps.manifest.outputs.has_manifest != 'true')
        run: |
          if [ "${{ needs.detect-dbt.outputs.has_models }}" = "true" ]; then
            dbt build --fail-fast
          else
            echo "No models found, skipping dbt build"
          fi

      - name: dbt docs generate
        if: steps.creds.outputs.has_creds == 'true' && needs.detect-dbt.outputs.has_models == 'true'
        run: dbt docs generate

      - name: Upload dbt artifacts
        if: steps.creds.outputs.has_creds == 'true' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dbt-artifacts
          path: |
            target/manifest.json
            target/run_results.json
            target/catalog.json
          retention-days: 30

  dbt-complete:
    if: always()
    needs: [detect-dbt, dbt-build]
    runs-on: ubuntu-24.04
    steps:
      - name: Check dbt CI results
        run: |
          if [ "${{ needs.dbt-build.result }}" = "failure" ]; then
            echo "dbt CI failed"
            exit 1
          fi
          echo "dbt CI passed or skipped"
