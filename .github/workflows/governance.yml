name: Governance

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  protocol-zero:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Check for AI attribution markers
        run: |
          FORBIDDEN_PATTERNS=(
            "Generated by AI"
            "As an AI"
            "I have updated"
            "LLM-optimized"
            "Co-authored-by:.*Claude"
            "Co-authored-by:.*GPT"
            "Co-authored-by:.*Copilot"
            "Co-Authored-By:.*noreply@anthropic"
            "Co-Authored-By:.*noreply@openai"
          )
          VIOLATIONS=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if git diff origin/main...HEAD --name-only 2>/dev/null | head -1 | grep -q . 2>/dev/null; then
              MATCHES=$(git diff origin/main...HEAD -U0 2>/dev/null | grep -iE "$pattern" || true)
            else
              MATCHES=$(grep -riE "$pattern" --include="*.py" --include="*.sql" --include="*.yml" --include="*.yaml" --include="*.md" . 2>/dev/null | grep -v "CLAUDE.md" | grep -v ".github/workflows" || true)
            fi
            if [ -n "$MATCHES" ]; then
              echo "::error::Protocol Zero violation: Found forbidden pattern '$pattern'"
              echo "$MATCHES"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Found $VIOLATIONS Protocol Zero violations"
            exit 1
          fi
          echo "Protocol Zero check passed"

  validate-skills:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check skill structure
        run: |
          SKILLS_DIR=".claude/skills"
          if [ ! -d "$SKILLS_DIR" ]; then
            echo "No skills directory found, skipping validation"
            exit 0
          fi
          ERRORS=0
          for skill_dir in "$SKILLS_DIR"/*/; do
            if [ -d "$skill_dir" ]; then
              skill_name=$(basename "$skill_dir")
              echo "Validating skill: $skill_name"
              if [ ! -f "${skill_dir}SKILL.md" ]; then
                echo "::error::Skill '$skill_name' missing SKILL.md"
                ERRORS=$((ERRORS + 1))
                continue
              fi
              if ! head -1 "${skill_dir}SKILL.md" | grep -q "^---$"; then
                echo "::error::Skill '$skill_name' SKILL.md missing YAML frontmatter"
                ERRORS=$((ERRORS + 1))
              fi
              if ! grep -q "^name:" "${skill_dir}SKILL.md"; then
                echo "::error::Skill '$skill_name' SKILL.md missing 'name' field"
                ERRORS=$((ERRORS + 1))
              fi
              if ! grep -q "^description:" "${skill_dir}SKILL.md"; then
                echo "::error::Skill '$skill_name' SKILL.md missing 'description' field"
                ERRORS=$((ERRORS + 1))
              fi
              LINE_COUNT=$(wc -l < "${skill_dir}SKILL.md")
              if [ "$LINE_COUNT" -gt 500 ]; then
                echo "::error::Skill '$skill_name' SKILL.md exceeds 500 lines ($LINE_COUNT)"
                ERRORS=$((ERRORS + 1))
              fi
              for forbidden in "README.md" "CHANGELOG.md" "INSTALLATION_GUIDE.md"; do
                if [ -f "${skill_dir}${forbidden}" ]; then
                  echo "::error::Skill '$skill_name' contains forbidden file: $forbidden"
                  ERRORS=$((ERRORS + 1))
                fi
              done
            fi
          done
          if [ -f ".claude/skills/skill-creator/scripts/validate_skill.py" ]; then
            echo "Running skill validator script..."
            for skill_dir in "$SKILLS_DIR"/*/; do
              if [ -d "$skill_dir" ]; then
                python .claude/skills/skill-creator/scripts/validate_skill.py "$skill_dir" || ERRORS=$((ERRORS + 1))
              fi
            done
          fi
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS skill validation errors"
            exit 1
          fi
          echo "Skill validation passed"

  commit-lint:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          COMMIT_PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9_-]+\))?: .{1,72}$"
          ERRORS=0
          while IFS= read -r commit_hash; do
            MSG=$(git log --format=%s -n 1 "$commit_hash")
            if ! echo "$MSG" | grep -qE "$COMMIT_PATTERN"; then
              echo "::error::Invalid commit message format: $MSG"
              echo "Expected: type(scope): description"
              echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
              ERRORS=$((ERRORS + 1))
            fi
          done < <(git rev-list origin/main..HEAD 2>/dev/null || echo "")
          if [ $ERRORS -gt 0 ]; then
            echo "::warning::Found $ERRORS commits with non-conventional format"
          fi
          echo "Commit lint completed"

  repo-hygiene:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for sensitive files
        run: |
          SENSITIVE_PATTERNS=(
            "profiles.yml"
            ".env"
            "*.pem"
            "*.key"
            "*credentials*"
            "*secret*"
          )
          VIOLATIONS=0
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            MATCHES=$(find . -name "$pattern" -not -path "./.git/*" -not -name "*.example" -not -name "*.template" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              case "$pattern" in
                "profiles.yml")
                  if [ -f "profiles.yml" ] && ! grep -q "example\|template\|TODO\|REPLACE" profiles.yml 2>/dev/null; then
                    echo "::error::Sensitive file found: profiles.yml (may contain credentials)"
                    VIOLATIONS=$((VIOLATIONS + 1))
                  fi
                  ;;
                *)
                  echo "::warning::Potentially sensitive file pattern found: $pattern"
                  echo "$MATCHES"
                  ;;
              esac
            fi
          done
          if [ $VIOLATIONS -gt 0 ]; then
            exit 1
          fi
          echo "Repo hygiene check passed"

  governance-complete:
    if: always()
    needs: [protocol-zero, validate-skills, commit-lint, repo-hygiene]
    runs-on: ubuntu-24.04
    steps:
      - name: Check governance results
        run: |
          if [ "${{ needs.protocol-zero.result }}" = "failure" ] || \
             [ "${{ needs.validate-skills.result }}" = "failure" ] || \
             [ "${{ needs.repo-hygiene.result }}" = "failure" ]; then
            echo "Governance checks failed"
            exit 1
          fi
          echo "All governance checks passed"
