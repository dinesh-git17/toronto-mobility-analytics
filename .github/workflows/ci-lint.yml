name: CI Lint

on:
  pull_request:
    branches: [main]
    paths:
      - "**.py"
      - "**.sql"
      - "models/**"
      - "macros/**"
      - "analyses/**"
      - "tests/**"
      - "scripts/**"
      - "pyproject.toml"
      - "requirements*.txt"
      - ".sqlfluff"
      - ".github/workflows/**"
  push:
    branches: [main]
    paths:
      - "**.py"
      - "**.sql"
      - "models/**"
      - "macros/**"
      - "analyses/**"
      - "tests/**"
      - "scripts/**"
      - "pyproject.toml"
      - "requirements*.txt"
      - ".sqlfluff"
      - ".github/workflows/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  detect-changes:
    runs-on: ubuntu-24.04
    outputs:
      python: ${{ steps.filter.outputs.python }}
      sql: ${{ steps.filter.outputs.sql }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Detect file changes
        id: filter
        run: |
          if find . -name "*.py" -type f 2>/dev/null | head -1 | grep -q .; then
            echo "python=true" >> "$GITHUB_OUTPUT"
          else
            echo "python=false" >> "$GITHUB_OUTPUT"
          fi
          if find . -path ./target -prune -o -name "*.sql" -type f -print 2>/dev/null | head -1 | grep -q .; then
            echo "sql=true" >> "$GITHUB_OUTPUT"
          else
            echo "sql=false" >> "$GITHUB_OUTPUT"
          fi

  lint-python:
    needs: detect-changes
    if: needs.detect-changes.outputs.python == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          enable-cache: true
          cache-dependency-glob: |
            **/pyproject.toml
            **/requirements*.txt

      - name: Install linters
        run: uv tool install ruff

      - name: Run ruff check
        run: |
          if compgen -G "**/*.py" > /dev/null 2>&1; then
            ruff check . --output-format=github
          else
            echo "No Python files found, skipping ruff check"
          fi

      - name: Run ruff format check
        run: |
          if compgen -G "**/*.py" > /dev/null 2>&1; then
            ruff format --check .
          else
            echo "No Python files found, skipping ruff format"
          fi

  lint-sql:
    needs: detect-changes
    if: needs.detect-changes.outputs.sql == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          enable-cache: true

      - name: Install SQL tools
        run: |
          uv tool install shandy-sqlfmt==0.26.0
          uv tool install sqlfluff==3.3.1

      - name: Run sqlfmt check
        run: |
          # Only check dbt model directories (matching pre-commit config)
          SQL_DIRS=""
          for dir in models macros analyses; do
            if [ -d "$dir" ]; then
              SQL_DIRS="$SQL_DIRS $dir"
            fi
          done
          if [ -n "$SQL_DIRS" ]; then
            sqlfmt --check --exclude target $SQL_DIRS
          else
            echo "No SQL model directories found, skipping sqlfmt"
          fi

      - name: Run SQLFluff lint
        run: |
          SQL_DIRS=""
          for dir in models macros analyses tests; do
            if [ -d "$dir" ] && find "$dir" -name "*.sql" -type f | head -1 | grep -q .; then
              SQL_DIRS="$SQL_DIRS $dir"
            fi
          done
          if [ -n "$SQL_DIRS" ]; then
            sqlfluff lint $SQL_DIRS --dialect snowflake --format github-annotation || true
          else
            echo "No SQL directories with files found, skipping SQLFluff"
          fi

  lint-complete:
    if: always()
    needs: [detect-changes, lint-python, lint-sql]
    runs-on: ubuntu-24.04
    steps:
      - name: Check lint results
        run: |
          if [ "${{ needs.lint-python.result }}" = "failure" ] || [ "${{ needs.lint-sql.result }}" = "failure" ]; then
            echo "Lint checks failed"
            exit 1
          fi
          echo "All lint checks passed or skipped"
